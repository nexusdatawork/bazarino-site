---
import Layout from "@/layouts/Layout.astro";
import DealCard from "@/components/DealCard.astro";
import { achados } from "@/data/achados";
import { titleFromSlug } from "@/lib/slug";

export function getStaticPaths() {
  const set = new Set<string>();
  for (const a of achados) {
    if (a.category) set.add(String(a.category));
  }
  return Array.from(set).map((slug) => ({ params: { slug } }));
}

const { slug } = Astro.params;

const items = achados
  .filter((a) => String(a.category) === slug)
  .sort((a, b) => {
    const s = Number(b.score ?? 0) - Number(a.score ?? 0);
    if (s !== 0) return s;
    const da = a.date ? new Date(a.date).getTime() : 0;
    const db = b.date ? new Date(b.date).getTime() : 0;
    return db - da;
  });

const title = titleFromSlug(slug);
const pageTitle = `${title} | Achados do Bazarino`;
const pageDesc = `Achados em ${title}, com curadoria e foco em custo-benefício.`;
---

<Layout title={pageTitle} description={pageDesc}>
  <section class="mx-auto max-w-6xl px-4 pt-8 pb-12">
    <div class="flex flex-col gap-2">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Categoria</p>
      <h1 class="text-2xl sm:text-3xl font-semibold text-slate-900">{title}</h1>
      <p class="text-sm text-slate-600">{pageDesc}</p>
    </div>

    {items.length ? (
      <div class="mt-8 grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
        {items.map((a) => (
          <DealCard
            title={a.title}
            store={a.store}
            price={a.price}
            oldPrice={a.oldPrice}
            image={a.image}
            href={a.href}
            tag={a.category}
            reason={a.reason}
          />
        ))}
      </div>
    ) : (
      <div class="mt-10 rounded-2xl border border-slate-200 bg-white p-6 text-slate-700">
        Nada publicado nessa categoria ainda.
      </div>
    )}

    <div class="mt-10">
      <a href="/achados" class="text-sm font-semibold text-[var(--bazarino-blue)] hover:underline">
        ← Voltar para Achados
      </a>
    </div>
  </section>
</Layout>
