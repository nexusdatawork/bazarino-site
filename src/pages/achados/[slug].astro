---
import Layout from "@/layouts/Layout.astro";
import { achados } from "@/data/achados";

/**
 * ✅ Cloudflare-safe getStaticPaths:
 * - NÃO depende de funções fora do getStaticPaths (evita "is not defined")
 * - Calcula slug com id/sku/hash/index
 */
export function getStaticPaths() {
  const toSlug = (s: unknown) =>
    String(s ?? "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .toLowerCase()
      .replace(/[^a-z0-9]+/g, "-")
      .replace(/(^-|-$)/g, "");

  return (achados ?? []).map((a: any, index: number) => {
    const key = a?.id ?? a?.sku ?? a?.hash ?? index;
    const base = toSlug(a?.title ?? "achado");
    return { params: { slug: `${base}-${key}` } };
  });
}

// Helpers para o resto da página (fora do getStaticPaths pode!)
const toSlugRender = (s: unknown) =>
  String(s ?? "")
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "");

const { slug } = Astro.params;

function findItemBySlug() {
  for (let i = 0; i < (achados ?? []).length; i++) {
    const a: any = (achados as any[])[i];
    const key = a?.id ?? a?.sku ?? a?.hash ?? i;
    const base = toSlugRender(a?.title ?? "achado");
    if (`${base}-${key}` === slug) return a;
  }
  return null;
}

const item: any = findItemBySlug();

if (!item) {
  throw new Error(`Achado não encontrado para slug: ${slug}`);
}

const brl = (n: unknown) => {
  const v = Number(n);
  if (!Number.isFinite(v)) return "";
  return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
};

const pageTitle = `${item.title ?? "Achado"} | O Bazarino`;
const pageDesc =
  item.description ??
  "Achado bom e fino, com curadoria rápida e objetiva do O Bazarino.";

const canonical = `https://obazarino.com.br/achados/${slug}`;
const fallbackImg = `https://picsum.photos/seed/${encodeURIComponent(String(slug))}/1200/700`;
---

<Layout title={pageTitle} description={pageDesc} canonical={canonical}>
  <section class="mx-auto max-w-4xl px-4 py-10 space-y-8">
    <nav class="text-sm text-slate-500">
      <a href="/achados" class="hover:underline">Achados</a>
      <span class="mx-2">/</span>
      <span class="text-slate-700">{item.category ? item.category : "Detalhe"}</span>
    </nav>

    <header class="space-y-4">
      <h1 class="text-3xl font-semibold text-slate-900">{item.title}</h1>
      <p class="text-slate-700 leading-relaxed">{pageDesc}</p>

      <div class="flex flex-wrap gap-2 text-sm">
        {item.store ? (
          <span class="rounded-full border bg-white px-3 py-1">Loja: <strong>{item.store}</strong></span>
        ) : null}

        {item.category ? (
          <a class="rounded-full border bg-white px-3 py-1 hover:bg-slate-50" href={`/achados/categoria/${toSlugRender(item.category)}`}>
            Categoria: <strong>{item.category}</strong>
          </a>
        ) : null}

        {item.price ? (
          <span class="rounded-full border bg-white px-3 py-1">Preço: <strong>{brl(item.price)}</strong></span>
        ) : null}
      </div>
    </header>

    <img
      src={item.image ?? fallbackImg}
      alt={item.title}
      loading="lazy"
      decoding="async"
      class="w-full rounded-3xl border object-cover"
      onerror={`this.onerror=null;this.src='${fallbackImg}';`}
    />

    <div class="flex flex-wrap items-center gap-3">
      {item.href ? (
        <a
          class="inline-flex items-center justify-center rounded-full bg-[var(--bazarino-blue)] px-5 py-3 text-sm font-semibold text-white shadow-sm hover:opacity-95"
          href={item.href}
          target="_blank"
          rel="noopener noreferrer"
        >
          Ver oferta →
        </a>
      ) : null}

      <a class="text-sm font-semibold text-[var(--bazarino-blue)] hover:underline" href="/achados">
        ← Voltar para Achados
      </a>
    </div>

    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Product",
      "name": item.title,
      "image": item.image ? [item.image] : undefined,
      "description": pageDesc,
      "brand": item.store ? { "@type": "Brand", "name": item.store } : undefined,
      "offers": {
        "@type": "Offer",
        "priceCurrency": "BRL",
        "price": String(item.price ?? ""),
        "url": item.href,
        "availability": "https://schema.org/InStock"
      }
    })}></script>
  </section>
</Layout>
