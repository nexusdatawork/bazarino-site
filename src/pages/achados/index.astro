---
import Layout from "../../layouts/Layout.astro";
import { listDailyEditions, listCategoriesByFrequency } from "@/lib/achadosSource";
import { titleFromSlug } from "@/lib/slug";

const daily = listDailyEditions();
const latest = daily[0];

// ‚úÖ Exibe s√≥ a √∫ltima semana no hub principal
const WEEK_DAYS = 7;
const week = daily.slice(0, WEEK_DAYS);
const older = daily.slice(WEEK_DAYS);

// ‚úÖ Arquivo mensal (agrupa as edi√ß√µes antigas por AAAA-MM)
const monthMap = new Map<string, number>(); // key=YYYY-MM, count
for (const e of older) {
  const [y, m] = e.date.split("-");
  if (!y || !m) continue;
  const key = `${y}-${m}`;
  monthMap.set(key, (monthMap.get(key) ?? 0) + 1);
}
const months = [...monthMap.entries()]
  .map(([key, count]) => ({ key, count }))
  .sort((a, b) => (a.key < b.key ? 1 : -1)); // desc

const cats = listCategoriesByFrequency(12);
---

<Layout title="Achados ‚Ä¢ O Bazarino">
  <section class="space-y-10">
    <header class="space-y-3">
      <h1 class="text-2xl font-semibold">Achados</h1>
      <p class="max-w-3xl text-slate-700">
        Curadoria di√°ria de ofertas com score de custo-benef√≠cio. Aqui voc√™ encontra a edi√ß√£o do dia, a √∫ltima semana e o
        arquivo mensal (hist√≥rico). Sem ru√≠do, s√≥ utilidade. üôÇ
      </p>
    </header>

    {/* √öltima edi√ß√£o (acima da dobra) */}
    {latest ? (
      <section class="rounded-2xl border border-slate-200 bg-slate-50 p-6 space-y-3">
        <p class="text-sm text-slate-600">Edi√ß√£o mais recente ‚Ä¢ {latest.date}</p>
        <h2 class="text-xl font-semibold">{latest.title}</h2>
        {latest.intro ? <p class="max-w-3xl text-slate-700">{latest.intro}</p> : null}
        {(() => {
          const [ano, mes, dia] = (latest?.date ?? "").split("-");
          return ano && mes && dia ? (
            <a
              class="inline-flex items-center justify-center rounded-full bg-slate-900 px-5 py-2 text-sm font-semibold text-white hover:bg-slate-800 transition"
              href={`/achados/${ano}/${mes}/${dia}`}
            >
              Ver Top 10 de hoje
            </a>
          ) : null;
        })()}
      </section>
    ) : (
      <p class="text-slate-600">Ainda n√£o h√° edi√ß√µes publicadas.</p>
    )}

    {/* √öltimos 7 dias */}
    {week.length ? (
      <section class="space-y-4">
        <div class="flex items-center justify-between gap-4">
          <h2 class="text-lg font-semibold">√öltimos 7 dias</h2>
          <span class="text-xs text-slate-500">Para n√£o virar infinita: o resto vai para o arquivo mensal.</span>
        </div>

        <div class="rounded-xl border border-slate-200 overflow-hidden bg-white">
          <div class="divide-y divide-slate-200">
            {week.map((e) => {
              const [ano, mes, dia] = e.date.split("-");
              return (
                <a class="block px-4 py-4 hover:bg-slate-50 transition" href={`/achados/${ano}/${mes}/${dia}`}>
                  <div class="flex items-center justify-between gap-4">
                    <div class="min-w-0">
                      <p class="font-semibold text-slate-900 truncate">{e.title}</p>
                      <p class="text-sm text-slate-600">{e.date}</p>
                    </div>
                    <span class="text-sm underline">Abrir</span>
                  </div>
                </a>
              );
            })}
          </div>
        </div>
      </section>
    ) : null}

    {/* Arquivo mensal */}
    {months.length ? (
      <section class="space-y-4">
        <h2 class="text-lg font-semibold">Arquivo mensal</h2>
        <p class="text-sm text-slate-600 max-w-3xl">
          Edi√ß√µes mais antigas ficam organizadas por m√™s (perfeito para hist√≥rico e SEO limpo).
        </p>

        <div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3">
          {months.map(({ key, count }) => {
            const [ano, mes] = key.split("-");
            const label = new Date(`${key}-01T00:00:00`).toLocaleDateString("pt-BR", { month: "long", year: "numeric" });
            return (
              <a
                class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm hover:shadow-md hover:-translate-y-0.5 transition"
                href={`/achados/arquivo/${ano}/${mes}`}
              >
                <p class="text-sm text-slate-600">Arquivo</p>
                <p class="mt-1 text-base font-semibold text-slate-900 capitalize">{label}</p>
                <p class="mt-2 text-xs text-slate-500">{count} edi√ß√µes</p>
              </a>
            );
          })}
        </div>
      </section>
    ) : null}

    {/* Explorar por categoria */}
    {cats.length ? (
      <section class="space-y-4">
        <h2 class="text-lg font-semibold">Explorar por categoria</h2>
        <div class="flex flex-wrap gap-2">
          {cats.map((c) => (
            <a
              class="rounded-full border border-slate-200 bg-white px-3 py-1 text-sm hover:bg-slate-50 transition"
              href={`/achados/categoria/${c.slug}`}
            >
              {titleFromSlug(c.slug)} <span class="text-slate-400">({c.count})</span>
            </a>
          ))}
        </div>
      </section>
    ) : null}
  </section>
</Layout>
