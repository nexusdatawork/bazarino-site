---
import Layout from "@/layouts/Layout.astro";

const {
  title,
  description,
  pubDate,
  updatedDate,
  tags = [],
  author = "O Bazarino",
  image,
  canonical,
} = Astro.props as {
  title: string;
  description: string;
  pubDate: Date;
  updatedDate?: Date;
  tags?: string[];
  author?: string;
  image?: string;
  canonical?: string;
};

const currentUrl = new URL(Astro.url.pathname, Astro.site ?? "http://localhost");
const canonicalUrl = canonical ?? currentUrl.toString();

const published = pubDate instanceof Date ? pubDate : new Date(pubDate);
const modified = updatedDate ? (updatedDate instanceof Date ? updatedDate : new Date(updatedDate)) : published;

// cover default (se não vier image, usa picsum por slug)
const seed = Astro.url.pathname.replaceAll("/", "-") || "bazarino";
const cover = image ?? `https://picsum.photos/seed/${encodeURIComponent(seed)}/1400/800`;
const coverFallback = `https://picsum.photos/seed/${encodeURIComponent(seed + "-fallback")}/1400/800`;

const jsonLd = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description,
  author: { "@type": "Person", name: author },
  datePublished: published.toISOString(),
  dateModified: modified.toISOString(),
  mainEntityOfPage: canonicalUrl,
  image: cover ? [cover] : undefined,
};
---

<Layout title={`${title} | O Bazarino`}>
  <Fragment slot="head">
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalUrl} />

    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:type" content="article" />
    <meta property="og:image" content={cover} />

    <meta name="twitter:card" content="summary_large_image" />
    <script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />
  </Fragment>

  <article class="mx-auto max-w-3xl px-4 py-10">
    <nav class="mb-6 text-sm text-slate-600">
      <a href="/" class="hover:underline">Início</a>
      <span class="px-2">/</span>
      <a href="/blog" class="hover:underline">Blog</a>
    </nav>

    <!-- Hero do post: imagem com overlay + “card feel” -->
    <header class="overflow-hidden rounded-3xl border bg-white shadow-sm">
      <div class="relative">
        <img
          src={cover}
          alt={title}
          loading="eager"
          decoding="async"
          onerror={`this.onerror=null;this.src='${coverFallback}';`}
          class="h-56 w-full object-cover sm:h-72"
        />
        <div class="absolute inset-0 bg-gradient-to-t from-blue-950/80 via-blue-950/35 to-transparent"></div>

        <div class="absolute bottom-0 left-0 right-0 p-6 sm:p-8">
          <div class="flex flex-wrap items-center gap-2 text-xs text-white/85">
            <time datetime={published.toISOString()} class="rounded-full bg-white/10 px-3 py-1 font-semibold">
              {published.toLocaleDateString("pt-BR")}
            </time>

            {updatedDate && (
              <>
                <span class="text-white/50">•</span>
                <time datetime={modified.toISOString()} class="text-white/80">
                  atualizado em {modified.toLocaleDateString("pt-BR")}
                </time>
              </>
            )}

            {tags.length > 0 && (
              <>
                <span class="text-white/50">•</span>
                <span class="flex flex-wrap gap-2">
                  {tags.map((t) => (
                    <span class="rounded-full bg-white/10 px-2.5 py-1 text-xs text-white/85">
                      {t}
                    </span>
                  ))}
                </span>
              </>
            )}
          </div>

          <h1 class="mt-3 text-3xl font-semibold leading-tight text-white sm:text-4xl">
            {title}
          </h1>

          <p class="mt-2 max-w-2xl text-sm leading-relaxed text-white/85 sm:text-base">
            {description}
          </p>

          <p class="mt-4 text-sm text-white/75">
            Curadoria: <span class="font-semibold text-white/90">{author}</span>
          </p>
        </div>
      </div>
    </header>

    <div class="prose prose-slate mt-8 max-w-none">
      <slot />
    </div>

    <footer class="mt-10 border-t pt-6">
      <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
        <p class="text-sm text-slate-600">Texto e curadoria: {author}.</p>
        <a href="/blog" class="inline-flex items-center gap-2 text-sm font-semibold text-blue-800 hover:underline">
          Voltar para o Blog
          <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M5 12h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" />
            <path d="M13 6l6 6-6 6" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" />
          </svg>
        </a>
      </div>
    </footer>
  </article>
</Layout>
